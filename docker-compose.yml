services:
  oms-service:
    build: .
    ports:
      - '3000:3000'
    environment:
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://otel-collector:4318/v1/traces
      - OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://otel-collector:4318/v1/metrics
      - SERVICE_NAME=oms-service
    depends_on:
      - otel-collector

  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: signoz-clickhouse
    ports:
      - '8123:8123'
      - '9000:9000'
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_log:/var/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    mem_limit: 1g
    environment:
      - CLICKHOUSE_DB=signoz_traces
      - CLICKHOUSE_USER=signoz
      - CLICKHOUSE_PASSWORD=signoz
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: signoz-otel-collector
    command: ['--config=/etc/otel-collector-config.yaml']
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - '4317:4317'
      - '4318:4318'
      - '8888:8888'
    depends_on:
      clickhouse:
        condition: service_healthy

  query-service:
    image: signoz/query-service:latest
    container_name: signoz-query-service
    command: ["-config=/root/config/prometheus.yml"]
    ports:
      - '8080:8080'
      - '6060:6060'
    volumes:
      - ./signoz-config.yaml:/root/config/prometheus.yml
      - query_service_data:/var/lib/signoz
    environment:
      - ClickHouseUrl=tcp://clickhouse:9000
      - STORAGE=clickhouse
      - GODEBUG=netdns=go
      - TELEMETRY_ENABLED=true
      - DEPLOYMENT_TYPE=docker-standalone-amd
    depends_on:
      clickhouse:
        condition: service_healthy

  frontend:
    image: signoz/frontend:latest
    container_name: signoz-frontend
    ports:
      - '3301:3301'
    environment:
      - FRONTEND_API_ENDPOINT=http://query-service:8080
    depends_on:
      - query-service

volumes:
  clickhouse_data:
  clickhouse_log:
  query_service_data: